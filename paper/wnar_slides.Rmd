---
title: "Extending People-like-Me Methods with Mahalanobis distance"
subtitle: " A Personalized Predictive Longitudinal Study of Growth in Children"
author: "Randy (Xin) Jin"
date: "`r Sys.Date()`"
output: 
  beamer_presentation:
    theme: CambridgeUS
    colortheme: dolphin 
    number_sections: true
    slide_level: 2
    toc: true
    keep_tex: true
    latex_engine: xelatex
    dev: cairo_pdf

fontsize: 12pt
make149: yes
header-includes:
  - \AtBeginSubsection{}
  - \AtBeginSection{}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align='center')
```

# Introduction

## Objective

Modern clinical data analysis often deals with heterogeneous data

The traditional predictive modeling:

-   Develops a model for global inference with all data

-   Overlooks the diversity and heterogeneity

Personalized predictive methods

-   Have the objective of addressing heterogeneity

-   People-like-me method

## People-like-me method:

<!-- - Performs individualized curving matching --> People-like-me:

-   Uses a few but more similar trajectories

-   Predicts based on those similar trajectories

-   It can have higher predictive performance

-   Previous work has focused on finding matching trajectories based on a single time point

Our contribution is to:

1.  extend matching step to using more time points (**anchor time**)

2.  use alternative approaches to select matches

<!-- **The size and set of matching cohort based on multiple time imputation values** -->

<!--    Make nonlinear trajectory prediction for a out-of-sample target** -->

## Example trajectories

```{r out.width = '80%'}
knitr::include_graphics("final/00003a.png")
```

# Methods

## Flowchart

```{r out.width = '60%'}
knitr::include_graphics("final/Screenshot 2023-06-15 at 11.03.00 AM.png")
```

## Imputation

0.  Split dataset into training and testing. For every individual in the testing set $y_{test}$, do the following steps.

1.  Fit a brokenstick model with training set: $\pmb y_{train} \sim BrokenStick(\pmb X_{train})$

-   brokenstick model is a particular type of linear mixed model

-   piece-wise cubic B-splines for both fixed and random effect

2.  Obtain the predictions based on brokenstick model at fixed set of anchor time points $\pmb {\tau}= \{\tau_1,\ ... ,\ \tau_k\}$: predict outcomes for every subjects $i$ in training set: $\pmb{\tilde y_i} = (\tilde y_{i, \tau_1},\ ... ,\ \tilde y_{i, \tau_k})$

## Imputation

3.  Fit linear model with the predicted values from Step 2: $\pmb{\tilde y} \sim LM_{\pmb\tau}( \pmb {y_{train, 0}},\ \pmb {X_{train, 0}})$

-   This model includes only the demographic information and baseline outcome, at each time point independently

4.  Obtain the predictions based on the linear model for every training subject $\pmb{\bar y_i}$ and for the target individual $\pmb{\bar y_{test}}$

## Matching

5.  Calculate the distance between the target (test) and every training subject: $D_{i, test} = dist(\pmb{\bar y_i},\ \pmb{\bar y_{test}})$.

Two types of distance will be used

-   Euclidean distance: $D_{E} = \| \pmb {y_1}- \pmb {y_2}\| = \sqrt{\sum_{i = 1}^{k} (y_{1i} - y_{2i})^2}$

-   Mahalanobis distance: $D_{M} = \sqrt{(\pmb {y_1} - \pmb {y_2})^{\top} \pmb \Sigma ^{-1} (\pmb {y_1} - \pmb {y_2})}$

    -   where $\pmb {y_1} = (y_{11}, ... y_{1k})$ and $\pmb {y_2} = (y_{21},\ ... ,\ y_{2k})$; 
    -   $\pmb \Sigma$ is the variance-covariance matrix

## Matching

6.  Select the matching cohort as set $\pmb{A}$ from the training set, based on given distance in Step 5;

-   The top $\kappa$ smallest distance trajectories as matching set

-   Mahalanobis distance criterion

    -   $D_{M}^2 = {(\pmb {y_1} - \pmb {y_2})^{\top} \pmb \Sigma ^{-1} (\pmb {y_1} - \pmb {y_2})}$, $D_M^2 \sim \chi^2_k$, where $df = k$ is the degrees of freedom

    -   Then set $\pmb A$ may be chosen such that: $\pmb A = \Big\{\pmb y: {(\pmb y - \pmb {y^*})^{\top} \pmb \Sigma ^{-1} (\pmb y - \pmb {y^*})}) \leq \chi^2_{df = k,\ \alpha}\Big\}$.

## Prediction

7.  Use the matching trajectories of $(\pmb {y_{sub}},\ \pmb {X_{sub}}) \in \pmb{set A}$ from Step 6 to fit a flexible model, specifically GAMLSS (Generalized Additive Model for Location Scale and Shape) model: $\pmb {\hat y} \sim GAMLSS(\pmb {X_{sub}})$

-   We use the predicted median as the personalized prediction and the centiles as the predictive interval for the target individual

# Results


## Application

The Early Pseudomonas Infection Control (EPIC) Observational Study is a prospective, multi-center, observational longitudinal study. EPIC study aims to investigate progression of cystic fibrosis outcomes in children

\small

```{=tex}
\begin{table}[ht]
\centering
\begin{tabular}{rlll}
  \hline
 & $\pmb {Variable}$ & $\pmb {Testing}$, N = 457 & $\pmb {Training}$, N = 913 \\ 
  \hline
    & $\pmb {Female}$  & 237 (52\%) & 456 (50\%) \\ 
    & $\pmb {Age_{0}} (yr)$ & 3.14 (3.06, 3.23) & 3.13 (3.05, 3.22) \\ 
    & $\pmb {Age_{final}} (yr)$ & 12.7 (10.3, 16.0) & 12.8 (10.1, 16.0) \\ 
    & $\pmb {Follow.up} (yr)$ & 9.5 (7.2, 12.6) & 9.7 (7.0, 12.7) \\ 
    & $\pmb {Height_{0}} (cm)$ & 94.0 (91.5, 96.7) & 94.0 (91.4, 97.0) \\ 
   \hline
\end{tabular}
\end{table}
```


## 

```{r out.width = '80%'}
knitr::include_graphics("final/flow.png")
```

## 

```{r out.width = '100%', fig.align='center'}
knitr::include_graphics("final/individual_example_test_158000.png")
```

## EPIC Data Analysis

\small

|        | Anchor time     | $S_{\kappa = 10}^{t = 10}$ | $E_{\kappa = 10}$ | $M_{\kappa = 10}$ | $M_{\alpha = 0.85}$ | 
|-----------|------------------|-----------|-----------|-----------|-----------|
| Bias   | t(3, 6, 9, 12)  |3.36              | 2.65              | 2.31              | **2.21**                | 
|        | t(4, 8, 12, 16) |                   | 2.22              | 2.29              | **2.20**                |
| RMSE   |t(3, 6, 9, 12)   |  4.17            | 3.77              | 3.38              | **3.30**                |
|        | t(4, 8, 12, 16) |                    |3.43              | 3.49              | **3.29**                |
| 50% CI | t(3, 6, 9, 12)  | 0.45              | 0.61              | 0.38              | **0.64**                |
|        | t(4, 8, 12, 16) |                    |0.53              | 0.47              | **0.64**                |
| 80% CI | t(3, 6, 9, 12)  | 0.72              | 0.84              | 0.66              | **0.89**                |
|        | t(4, 8, 12, 16) |                    |0.79              | 0.74              | **0.89**                |

# Discussion

## Discussion

Summary:

-   Improved people-like-me method for personalized prediction

-   In the EPIC study, Mahalanobis distance ($\alpha=0.85$) performed better than the other methods

-   User-defined parameters: number of matches $\kappa$, $\alpha$, and anchor time set

-   We also conducted a simulation study to assess performance of the methods

    -   Mahalanobis distance ($\alpha=0.85$) provide more accurate estimates, higher precision, and better coverage

Future work

-   Imputation: use other prediction models

-   Prediction Modeling: weighted regression and penalization

-   Packaged functions for accessibility and application

## Simulation

We performed a simulation study

-   1000 simulated datasets
-   data generating mechanism based on linear mixed model
    -   fixed effect: piece-wise cubic B-spline
    -   random effect: piece-wise quadratic B-spline
-   performing people-like-me approach

## 

```{r out.width = '65%', fig.align='center'}
knitr::include_graphics("final/final_plots_20221208.png")
```

**EXTRA**

-   The brokenstick highly depends on the data near to the adjacent interval

-   We want to find a flexible and robust model to provide accurate predictions
